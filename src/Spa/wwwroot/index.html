<!DOCTYPE html>
<html>
<head>
    <script type="text/javascript">
        var sdkInstance = "appInsightsSDK"; window[sdkInstance] = "appInsights"; var aiName = window[sdkInstance], aisdk = window[aiName] || function (n) { var o = { config: n, initialize: !0 }, t = document, e = window, i = "script"; setTimeout(function () { var e = t.createElement(i); e.src = n.url || "https://az416426.vo.msecnd.net/scripts/b/ai.2.min.js", t.getElementsByTagName(i)[0].parentNode.appendChild(e) }); try { o.cookie = t.cookie } catch (e) { } function a(n) { o[n] = function () { var e = arguments; o.queue.push(function () { o[n].apply(o, e) }) } } o.queue = [], o.version = 2; for (var s = ["Event", "PageView", "Exception", "Trace", "DependencyData", "Metric", "PageViewPerformance"]; s.length;)a("track" + s.pop()); var r = "Track", c = r + "Page"; a("start" + c), a("stop" + c); var u = r + "Event"; if (a("start" + u), a("stop" + u), a("addTelemetryInitializer"), a("setAuthenticatedUserContext"), a("clearAuthenticatedUserContext"), a("flush"), o.SeverityLevel = { Verbose: 0, Information: 1, Warning: 2, Error: 3, Critical: 4 }, !(!0 === n.disableExceptionTracking || n.extensionConfig && n.extensionConfig.ApplicationInsightsAnalytics && !0 === n.extensionConfig.ApplicationInsightsAnalytics.disableExceptionTracking)) { a("_" + (s = "onerror")); var p = e[s]; e[s] = function (e, n, t, i, a) { var r = p && p(e, n, t, i, a); return !0 !== r && o["_" + s]({ message: e, url: n, lineNumber: t, columnNumber: i, error: a }), r }, n.autoExceptionInstrumented = !0 } return o }(
            {
                instrumentationKey: "",
                disableFetchTracking: false,
                enableCorsCorrelation: true
            }
        ); (window[aiName] = aisdk).queue && 0 === aisdk.queue.length && aisdk.trackPageView({});
    </script>
    <title>SPA - Func Demo</title>
    <script type="text/javascript" src="https://alcdn.msauth.net/lib/1.2.1/js/msal.min.js" integrity="sha384-Z4L5heyGO9VZ/MBCDx9GRtQW50Hrmp32ByIKuqwFesWyB+MDNy9ueVgclolfwj1Q" crossorigin="anonymous"></script>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <style type="text/css">
        html,
        body,
        input {
            padding-top: 0px;
            padding-bottom: 10px;
            padding-left: 20px;
            font-family: 'Segoe UI Light', sans-serif;
            font-size: 20px;
            text-align: left;
            margin: 0 auto;
            width: 800px;
        }
    </style>
    <script>
        let endpoint = "http://localhost:7071";

        let userAgentApplication;
        let accessTokenRequest;
        let accessToken;

        fetch("/configuration.json")
            .then(response => {
                return response.json();
            })
            .then(data => {
                console.log(data);
                processConfiguration(data)
            })
            .catch(error => {
                console.log(error);
                solutionElement.innerHTML = "Oh no! Couldn't fetch configuration settings 😥";
            });

        function processConfiguration(data) {
            aisdk.config.instrumentationKey = data.instrumentationKey;
            accessTokenRequest = {
                scopes: [data.applicationIdURI + "Sales.ReadWrite"]
            }

            const config = {
                auth: {
                    clientId: data.clientId,
                    authority: "https://login.microsoftonline.com/" + data.tenantId,
                }
            }

            userAgentApplication = new Msal.UserAgentApplication(config);
            function authCallback(error, response) {
                // Handle redirect responses
                if (error) {
                    console.log(error);
                }
                else {
                    if (response.tokenType === "id_token") {
                        console.log('id_token acquired at: ' + new Date().toString());
                    }
                    else if (response.tokenType === "access_token") {
                        console.log('access_token acquired at: ' + new Date().toString());
                        accessToken = response.accessToken;
                        afterLogin(response.account);
                    }
                    else {
                        console.log("token type is:" + response.tokenType);
                    }
                }
            }

            userAgentApplication.handleRedirectCallback(authCallback);

            userAgentApplication.acquireTokenSilent(accessTokenRequest).then(function (accessTokenResponse) {
                // Acquire token silent success
                // Call API with token
                console.log(accessTokenResponse);
                accessToken = accessTokenResponse.accessToken;
                afterLogin(accessTokenResponse.account);
            }).catch(function (error) {
                // Acquire token silent failure, and send an interactive request
                if (error.errorMessage.indexOf("User login is required") !== -1) {
                    userAgentApplication.acquireTokenRedirect(accessTokenRequest);
                }
            });
        }

        function login() {
            userAgentApplication.loginRedirect(accessTokenRequest);
        }

        function afterLogin(account) {
            document.getElementById("loginButton").style.display = "none";
            document.getElementById("meButton").style.display = "";
            document.getElementById("user").innerText = account.name;
        }

        function callMe() {
            fetch(endpoint + "/api/me",
                {
                    headers: {
                        "Accept": "application/json",
                        "Authorization": "Bearer " + accessToken
                    }
                })
                .then(response => {
                    return response.json();
                })
                .then(data => {
                    console.log(data);
                })
                .catch(error => {
                    console.log(error);
                });
        }
    </script>
</head>
<body>
    <h1>
        SPA + Func
    </h1>
    <div id="user">Anonymous</div>
    <p>
        <input id="loginButton" type="button" value="Login" onclick="login();" />
    </p>
    <p>
        <input id="meButton" type="button" value="Me" onclick="callMe();" style="display: none" />
    </p>
</body>
</html>
